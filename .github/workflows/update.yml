# Create branches with automatic 0watch updates
name: Update
on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 2 * * *'

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - name: Set up directory structure
        uses: 0install/apps/.github/actions/setup@master
      - name: Run 0watch
        env:
          GITHUB_TOKEN: ${{github.token}}
        run: feeds\watch.ps1
      - name: Upload generated feeds
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-feeds
          path: incoming

  macos:
    runs-on: macos-latest
    steps:
      - name: Set up directory structure
        uses: 0install/apps/.github/actions/setup@master
      - name: Run 0watch
        env:
          GITHUB_TOKEN: ${{github.token}}
        run: feeds/watch.sh
      - name: Upload generated feeds
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-feeds
          path: incoming

  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Set up directory structure
        uses: 0install/apps/.github/actions/setup@master
      - name: Run 0watch
        env:
          GITHUB_TOKEN: ${{github.token}}
        run: |
          sudo apt-get -qq install python3-gnupg
          feeds/watch.sh
      - name: Upload generated feeds
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-feeds
          path: incoming

  merge:
    runs-on: ubuntu-latest
    needs: [windows, macos, linux]
    steps:
      - name: Set up directory structure
        uses: 0install/apps/.github/actions/setup@master
      - name: Download feeds generated on Windows
        uses: actions/download-artifact@v4
        with:
          name: windows-feeds
          path: incoming
      - name: Download feeds generated on MacOS
        uses: actions/download-artifact@v4
        with:
          name: macos-feeds
          path: incoming
      - name: Download feeds generated on Linux
        uses: actions/download-artifact@v4
        with:
          name: linux-feeds
          path: incoming
      - name: Check if there are new feeds
        id: new-feeds
        run: if ls incoming/*.xml; then echo "found=true" >> $GITHUB_OUTPUT; fi
      - name: Run 0repo
        uses: 0install/apps/.github/actions/0repo@master
        if: steps.new-feeds.outputs.found
      - name: Create Pull Request
        if: steps.new-feeds.outputs.found
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{github.token}}
          path: feeds
          branch: automatic-updates
          title: Automatic updates
          body: Automatic updates generated by 0watch scripts
