# Create branches with automatic 0watch updates
name: Update
on:
  schedule:
    - cron: '0 2 * * *'

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - name: Set up 0install
        run: |
          Invoke-WebRequest https://0install.de/files/0install.exe -OutFile 0install.exe
          echo "::add-path::$env:GITHUB_WORKSPACE"
      - name: Clone feeds
        uses: actions/checkout@v2
        with:
          path: feeds
      - name: Set up repo
        run: mkdir incoming | Out-Null
      - name: Run 0watch
        env: {'CI': '1'}
        run: feeds\watch.ps1
      - name: Upload generated feeds
        uses: actions/upload-artifact@v1
        with:
          name: windows-feeds
          path: incoming

  macos:
    runs-on: macos-latest
    steps:
      - name: Set up 0install
        run: |
          set -e
          curl -slO https://0install.de/files/0install-macos-latest.zip
          unzip 0install-macos-latest.zip -d 0install
          chmod +x 0install/files/0install
          echo "::add-path::$GITHUB_WORKSPACE/0install/files"
      - name: Clone feeds
        uses: actions/checkout@v2
        with:
          path: feeds
      - name: Set up repo
        run: mkdir incoming
      - name: Run 0watch
        env: {'CI': '1'}
        run: feeds/watch.sh
      - name: Upload generated feeds
        uses: actions/upload-artifact@v1
        with:
          name: macos-feeds
          path: incoming

  linux:
    runs-on: ubuntu-latest
    needs: [windows, macos]
    steps:
      - name: Set up 0install
        run: |
          set -e
          sudo apt-get update && sudo apt-get install -y python-gobject python3-gnupg unzip rpm2cpio binutils
          curl -L https://downloads.sourceforge.net/zero-install/0install-linux-x86_64-2.15.2.tar.bz2 | tar xj
          sudo 0install-linux-x86_64-2.15.2/install.sh local
      - name: Clone feeds
        uses: actions/checkout@v2
        with:
          path: feeds
      - name: Clone public
        uses: actions/checkout@v2
        with:
          path: public
          ref: gh-pages
      - name: Set up repo
        run: |
          cp feeds/0repo-config.py .
          cp public/archives.db .
      - name: Download feeds generated on Windows
        uses: actions/download-artifact@v1
        with:
          name: windows-feeds
          path: incoming
      - name: Download feeds generated on MacOS
        uses: actions/download-artifact@v1
        with:
          name: macos-feeds
          path: incoming
      - name: Run 0watch
        env: {'CI': '1'}
        run: |
          feeds/watch.sh
          if ls incoming/*.xml; then echo "::set-env name=NEW_INCOMING::true"; fi
      - name: Run 0repo
        if: env.NEW_INCOMING
        env: {'NO_SIGN': '1'}
        run: 0install run --not-before 0.10 http://0install.net/tools/0repo.xml
      - name: Create Pull Request
        if: env.NEW_INCOMING
        uses: peter-evans/create-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: feeds
          branch: automatic-updates
          title: Automatic updates
          body: Automatic updates generated by 0watch scripts
